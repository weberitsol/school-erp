// School Management ERP - Database Schema
// Using Prisma ORM with PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
  STUDENT
  PARENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Category/Caste for NEET/JEE reservations
enum Category {
  GENERAL
  OBC_NCL    // OBC Non-Creamy Layer
  OBC_CL     // OBC Creamy Layer (treated as General)
  SC         // Scheduled Caste
  ST         // Scheduled Tribe
  EWS        // Economically Weaker Section
}

// Person with Disability types
enum PwDType {
  NONE
  LOCOMOTOR            // 40-100% disability
  VISUAL               // Blindness/Low vision
  HEARING              // Deaf/Hard of hearing
  SPEECH               // Speech impairment
  INTELLECTUAL         // Intellectual disability
  MENTAL_ILLNESS       // Mental illness
  MULTIPLE             // Multiple disabilities
  AUTISM               // Autism spectrum
  SPECIFIC_LEARNING    // Dyslexia, etc.
  CEREBRAL_PALSY
  MUSCULAR_DYSTROPHY
  CHRONIC_NEUROLOGICAL
  BLOOD_DISORDER       // Thalassemia, Hemophilia, Sickle Cell
  ACID_ATTACK_VICTIM
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  HOLIDAY
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
  CHEQUE
  ONLINE
}

enum InvoiceStatus {
  PENDING
  PAID
  PARTIAL
  OVERDUE
  CANCELLED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ExamType {
  UNIT_TEST
  MIDTERM
  FINAL
  ASSIGNMENT
  PRACTICAL
  PROJECT
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

// Task Management Enums
enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ==================== CORE MODELS ====================

model School {
  id              String    @id @default(uuid())
  name            String
  code            String    @unique
  address         String?
  city            String?
  state           String?
  country         String    @default("India")
  pincode         String?
  phone           String?
  email           String?
  website         String?
  logo            String?
  establishedYear Int?
  affiliationNo   String?
  boardType       String?   // CBSE, ICSE, State Board, etc.
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  users           User[]
  academicYears   AcademicYear[]
  classes         Class[]
  subjects        Subject[]
  departments     Department[]
  feeStructures   FeeStructure[]
  feeInvoices     FeeInvoice[]
  announcements   Announcement[]
  holidays        Holiday[]

  // Library
  bookCategories  BookCategory[]
  books           Book[]
  bookUploadJobs  BookUploadJob[]

  // Admin Master Data
  branches          Branch[]
  tags              Tag[]
  assessmentReasons AssessmentReason[]
  tasks             Task[]

  // YouTube Videos
  youtubeVideos     YouTubeVideo[]

  // Transportation
  vehicles          Vehicle[]
  drivers           Driver[]
  routes            Route[]
  stops             Stop[]
  trips             Trip[]
  maintenanceLogs   VehicleMaintenanceLog[]
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  password        String
  role            UserRole
  isActive        Boolean   @default(true)
  lastLogin       DateTime?
  refreshToken    String?
  fcmToken        String?   // For push notifications
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  student         Student?
  teacher         Teacher?
  parent          Parent?
  admin           Admin?

  sentMessages    Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  notifications   Notification[]

  // Document AI & Tests
  uploadedDocuments UploadedDocument[]
  questionsCreated Question[]
  onlineTestsCreated OnlineTest[]
  assignmentsCreated Assignment[]

  // Library
  uploadedBooks   Book[] @relation("UploadedBooks")
  bookAnnotations BookAnnotation[] @relation("BookAnnotations")
  bookQAAsked     BookQA[] @relation("BookQAAsked")

  // Task Management
  assignedTasks      Task[] @relation("TaskAssignee")
  createdTasks       Task[] @relation("TaskCreator")
  performedTransfers BatchTransfer[]

  // YouTube Videos
  videosCreated      YouTubeVideo[] @relation("VideoCreator")

  // Transportation
  driver             Driver?
  recordedMaintenanceLogs VehicleMaintenanceLog[]

  @@index([email])
  @@index([schoolId])
}

model Admin {
  id              String    @id @default(uuid())
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName       String
  lastName        String
  phone           String?
  designation     String?
  profileImage    String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== STUDENT MODULE ====================

model Student {
  id              String    @id @default(uuid())
  
  // User relation
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  admissionNo     String    @unique
  rollNo          String?
  firstName       String
  lastName        String
  dateOfBirth     DateTime
  gender          Gender
  bloodGroup      String?
  profileImage    String?
  
  // Contact Info
  phone           String?
  address         String?
  city            String?
  state           String?
  pincode         String?
  
  // Academic Info
  admissionDate   DateTime  @default(now())
  previousSchool  String?
  
  // Current Class
  currentClassId  String?
  currentClass    Class?    @relation(fields: [currentClassId], references: [id])
  currentSectionId String?
  currentSection  Section?  @relation(fields: [currentSectionId], references: [id])

  // Branch
  currentBranchId String?
  currentBranch   Branch?   @relation(fields: [currentBranchId], references: [id])
  
  // Medical Info
  medicalConditions String?
  allergies       String?

  // ==================== NEET/JEE Eligibility Fields ====================
  // These fields are optional but required for college prediction feature

  // Category/Reservation Details
  category        Category?           // General, OBC-NCL, SC, ST, EWS
  subCategory     String?             // Sub-caste if applicable
  isCreamyLayer   Boolean?            // For OBC - true means no reservation benefit

  // Domicile Information (Important for State Quota)
  domicileState   String?             // State of permanent residence
  isDomicile      Boolean   @default(false)  // Has valid domicile certificate
  domicileCertNo  String?             // Domicile certificate number

  // Nationality
  nationality     String?   @default("Indian")  // Indian, NRI, OCI, PIO, Foreign

  // Person with Disability (PwD)
  pwdType         PwDType   @default(NONE)
  pwdPercentage   Int?                // Disability percentage (40-100 for benefits)
  pwdCertNo       String?             // PwD certificate number

  // Economic Status (for EWS)
  annualFamilyIncome Decimal?         // Annual family income in INR
  isEWS           Boolean   @default(false)  // Economically Weaker Section
  ewsCertNo       String?             // EWS certificate number

  // Additional Quota Eligibility
  isDefenseQuota  Boolean   @default(false)  // Defense personnel ward
  isKashmiriMigrant Boolean @default(false)  // J&K Migrant
  isSingleGirl    Boolean   @default(false)  // Single Girl Child (some states)

  // Identity Documents (for verification)
  aadharNo        String?             // 12-digit Aadhar number

  // Parent/Guardian Category (needed for some reservations)
  fatherOccupation String?
  motherOccupation String?

  // ==================== End NEET/JEE Fields ====================

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  parents         StudentParent[]
  attendances     StudentAttendance[]
  feePayments     FeePayment[]
  feeInvoices     FeeInvoice[]
  examResults     ExamResult[]
  enrollments     ClassEnrollment[]

  // Online Tests & Assignments
  testAttempts    TestAttempt[]
  assignmentSubmissions AssignmentSubmission[]

  // Batch Transfers
  transfers       BatchTransfer[]

  // Practice MCQ
  practiceAttempts  PracticeAttempt[]
  practiceSessions  PracticeSession[]

  // YouTube Video Sessions
  videoWatchSessions VideoWatchSession[]

  // Study Planner
  studyPlans          StudyPlan[]

  // Transportation
  routeAssignments    StudentRoute[]
  tripRecords         StudentTripRecord[]

  @@index([admissionNo])
  @@index([currentClassId])
  @@index([currentBranchId])
}

model Parent {
  id              String    @id @default(uuid())
  
  // User relation
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  firstName       String
  lastName        String
  relation        String    // Father, Mother, Guardian
  phone           String
  alternatePhone  String?
  email           String?
  occupation      String?
  profileImage    String?
  
  // Address
  address         String?
  city            String?
  state           String?
  pincode         String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  children        StudentParent[]
  feePayments     FeePayment[]
}

model StudentParent {
  id              String    @id @default(uuid())
  studentId       String
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parentId        String
  parent          Parent    @relation(fields: [parentId], references: [id], onDelete: Cascade)
  isPrimary       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())

  @@unique([studentId, parentId])
}

// ==================== TEACHER MODULE ====================

model Teacher {
  id              String    @id @default(uuid())
  
  // User relation
  userId          String    @unique
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic Info
  employeeId      String    @unique
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  gender          Gender
  profileImage    String?
  
  // Contact Info
  phone           String
  alternatePhone  String?
  address         String?
  city            String?
  state           String?
  pincode         String?
  
  // Professional Info
  qualification   String?
  specialization  String?
  experience      Int?      // Years
  joiningDate     DateTime  @default(now())
  
  // Department
  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])

  // Branch
  branchId        String?
  branch          Branch?   @relation(fields: [branchId], references: [id])

  // Salary Info
  salary          Decimal?  @db.Decimal(10, 2)
  bankAccount     String?
  bankName        String?
  ifscCode        String?
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  classTeacher    Section[] @relation("ClassTeacher")
  subjectTeachers SubjectTeacher[]
  attendances     TeacherAttendance[]
  leaves          Leave[]
  timetableSlots  TimetableSlot[]
  examsCreated    Exam[]
  gradesEntered   ExamResult[]

  @@index([employeeId])
  @@index([branchId])
}

model Department {
  id              String    @id @default(uuid())
  name            String
  code            String
  description     String?
  headId          String?   // Department head teacher
  
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  teachers        Teacher[]
  subjects        Subject[]

  @@unique([schoolId, code])
}

// ==================== ACADEMIC MODULE ====================

model AcademicYear {
  id              String    @id @default(uuid())
  name            String    // e.g., "2024-25"
  startDate       DateTime
  endDate         DateTime
  isCurrent       Boolean   @default(false)
  
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  terms           Term[]
  enrollments     ClassEnrollment[]
  feeStructures   FeeStructure[]
  exams           Exam[]

  // Library
  bookAccess      BookAccess[]

  // YouTube Videos
  videoAccess     VideoAccess[]

  @@unique([schoolId, name])
}

model Term {
  id              String    @id @default(uuid())
  name            String    // e.g., "Term 1", "Semester 1"
  startDate       DateTime
  endDate         DateTime
  
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  exams           Exam[]
}

model Class {
  id              String    @id @default(uuid())
  name            String    // e.g., "Class 10", "Grade 5"
  code            String    // e.g., "10", "5"
  displayOrder    Int       @default(0)

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  // Branch
  branchId        String?
  branch          Branch?   @relation(fields: [branchId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  sections        Section[]
  students        Student[]
  subjects        ClassSubject[]
  enrollments     ClassEnrollment[]
  feeStructures   FeeStructure[]
  timetables      Timetable[]
  exams           Exam[]

  // Document AI & Tests
  uploadedDocuments UploadedDocument[]
  questions       Question[]
  onlineTests     OnlineTest[]
  assignments     Assignment[]

  // Library
  bookAccess      BookAccess[]

  // YouTube Videos
  videoAccess     VideoAccess[]

  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([branchId])
}

model Section {
  id              String    @id @default(uuid())
  name            String    // e.g., "A", "B", "C"
  capacity        Int       @default(40)
  
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  
  // Class Teacher
  classTeacherId  String?
  classTeacher    Teacher?  @relation("ClassTeacher", fields: [classTeacherId], references: [id])
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  students        Student[]
  enrollments     ClassEnrollment[]
  timetables      Timetable[]
  attendances     StudentAttendance[]
  exams           Exam[]

  // Online Tests & Assignments
  onlineTests     OnlineTest[]
  assignments     Assignment[]

  // Library
  bookAccess      BookAccess[]

  // YouTube Videos
  videoAccess     VideoAccess[]

  @@unique([classId, name])
}

model Subject {
  id              String    @id @default(uuid())
  name            String
  code            String
  description     String?

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  departmentId    String?
  department      Department? @relation(fields: [departmentId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  classSubjects   ClassSubject[]
  teachers        SubjectTeacher[]
  timetableSlots  TimetableSlot[]
  exams           Exam[]
  chapters        Chapter[]

  // Document AI & Tests
  uploadedDocuments UploadedDocument[]
  questions       Question[]
  onlineTests     OnlineTest[]
  assignments     Assignment[]
  testPatterns    TestPattern[]

  // Library
  books           Book[]

  // YouTube Videos
  youtubeVideos   YouTubeVideo[]

  // Study Planner
  studyPlans      StudyPlan[]

  @@unique([schoolId, code])
}

// ==================== CHAPTER MODULE (NCERT Structure) ====================

model Chapter {
  id              String    @id @default(uuid())
  name            String
  chapterNumber   Int
  description     String?   @db.Text

  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])

  // For specific class level (e.g., Class 11 Physics vs Class 12 Physics)
  classLevel      String?   // "11", "12" etc.

  // NCERT specific metadata
  ncertBook       String?   // "NCERT Physics Part 1"
  pageRange       String?   // "1-45"

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  questions       Question[]
  comprehensionPassages ComprehensionPassage[]

  // Library
  bookChapters    BookChapter[]

  // Study Planner
  studyPlans      StudyPlan[]

  @@unique([subjectId, chapterNumber, classLevel])
  @@index([subjectId])
}

// ==================== COMPREHENSION PASSAGE (For linked questions) ====================

model ComprehensionPassage {
  id              String    @id @default(uuid())
  title           String
  passageText     String    @db.Text
  passageHtml     String?   @db.Text
  passageImage    String?   // Image URL if any

  subjectId       String
  chapterId       String?
  chapter         Chapter?  @relation(fields: [chapterId], references: [id])

  source          QuestionSource @default(MANUAL)

  createdById     String

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations - questions linked to this passage
  questions       Question[]

  @@index([subjectId])
  @@index([chapterId])
}

model ClassSubject {
  id              String    @id @default(uuid())
  
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  
  isElective      Boolean   @default(false)
  weeklyPeriods   Int       @default(4)
  
  createdAt       DateTime  @default(now())

  @@unique([classId, subjectId])
}

model SubjectTeacher {
  id              String    @id @default(uuid())
  
  teacherId       String
  teacher         Teacher   @relation(fields: [teacherId], references: [id])
  
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  
  createdAt       DateTime  @default(now())

  @@unique([teacherId, subjectId])
}

model ClassEnrollment {
  id              String    @id @default(uuid())
  
  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])
  
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  
  sectionId       String
  section         Section   @relation(fields: [sectionId], references: [id])
  
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  
  rollNo          String?
  enrolledAt      DateTime  @default(now())
  
  @@unique([studentId, academicYearId])
  @@index([classId, sectionId, academicYearId])
}

// ==================== TIMETABLE MODULE ====================

model Timetable {
  id              String    @id @default(uuid())
  name            String    // e.g., "Class 10-A Timetable"
  
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  
  sectionId       String
  section         Section   @relation(fields: [sectionId], references: [id])
  
  effectiveFrom   DateTime
  effectiveTo     DateTime?
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  slots           TimetableSlot[]

  @@index([classId, sectionId])
}

model TimetableSlot {
  id              String    @id @default(uuid())
  
  timetableId     String
  timetable       Timetable @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  
  dayOfWeek       DayOfWeek
  periodNumber    Int
  startTime       String    // "09:00"
  endTime         String    // "09:45"
  
  subjectId       String?
  subject         Subject?  @relation(fields: [subjectId], references: [id])
  
  teacherId       String?
  teacher         Teacher?  @relation(fields: [teacherId], references: [id])
  
  room            String?
  isBreak         Boolean   @default(false)
  breakType       String?   // "Short Break", "Lunch"
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([timetableId, dayOfWeek, periodNumber])
}

// ==================== ATTENDANCE MODULE ====================

model StudentAttendance {
  id              String    @id @default(uuid())
  
  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])
  
  sectionId       String
  section         Section   @relation(fields: [sectionId], references: [id])
  
  date            DateTime  @db.Date
  status          AttendanceStatus
  remarks         String?
  
  markedById      String?   // Teacher who marked
  markedAt        DateTime  @default(now())
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([studentId, date])
  @@index([sectionId, date])
  @@index([date])
}

model TeacherAttendance {
  id              String    @id @default(uuid())
  
  teacherId       String
  teacher         Teacher   @relation(fields: [teacherId], references: [id])
  
  date            DateTime  @db.Date
  status          AttendanceStatus
  checkInTime     String?
  checkOutTime    String?
  remarks         String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([teacherId, date])
  @@index([date])
}

model Leave {
  id              String    @id @default(uuid())
  
  teacherId       String
  teacher         Teacher   @relation(fields: [teacherId], references: [id])
  
  leaveType       String    // Sick, Casual, Earned, etc.
  startDate       DateTime  @db.Date
  endDate         DateTime  @db.Date
  reason          String
  status          LeaveStatus @default(PENDING)
  
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([teacherId])
  @@index([status])
}

// ==================== EXAMINATION MODULE ====================

model Exam {
  id              String    @id @default(uuid())
  name            String    // e.g., "Mid-Term Exam 2024"
  examType        ExamType
  
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  
  termId          String?
  term            Term?     @relation(fields: [termId], references: [id])
  
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  
  sectionId       String?
  section         Section?  @relation(fields: [sectionId], references: [id])
  
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  
  date            DateTime  @db.Date
  startTime       String?
  endTime         String?
  
  maxMarks        Decimal   @db.Decimal(5, 2)
  passingMarks    Decimal   @db.Decimal(5, 2)
  weightage       Decimal   @default(100) @db.Decimal(5, 2) // Percentage weightage
  
  createdById     String
  createdBy       Teacher   @relation(fields: [createdById], references: [id])
  
  isPublished     Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  results         ExamResult[]

  @@index([classId, subjectId])
  @@index([academicYearId])
}

model ExamResult {
  id              String    @id @default(uuid())
  
  examId          String
  exam            Exam      @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])
  
  marksObtained   Decimal?  @db.Decimal(5, 2)
  grade           String?
  remarks         String?
  isAbsent        Boolean   @default(false)
  
  enteredById     String
  enteredBy       Teacher   @relation(fields: [enteredById], references: [id])
  enteredAt       DateTime  @default(now())
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([examId, studentId])
  @@index([studentId])
}

model GradeScale {
  id              String    @id @default(uuid())
  name            String    // e.g., "A+", "A", "B+"
  minPercentage   Decimal   @db.Decimal(5, 2)
  maxPercentage   Decimal   @db.Decimal(5, 2)
  gradePoint      Decimal   @db.Decimal(3, 2)
  description     String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// ==================== FEE MODULE ====================

model FeeStructure {
  id              String    @id @default(uuid())
  name            String    // e.g., "Tuition Fee", "Transport Fee"
  description     String?
  
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])
  
  academicYearId  String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  
  classId         String?
  class           Class?    @relation(fields: [classId], references: [id])
  
  amount          Decimal   @db.Decimal(10, 2)
  frequency       String    // Monthly, Quarterly, Annually, One-time
  dueDay          Int?      // Day of month when due
  lateFee         Decimal   @default(0) @db.Decimal(10, 2)
  lateFeeAfterDays Int      @default(10)
  
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  payments        FeePayment[]
  invoiceLineItems InvoiceLineItem[]

  @@index([schoolId, academicYearId])
}

model FeePayment {
  id              String    @id @default(uuid())
  receiptNo       String    @unique

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])

  feeStructureId  String
  feeStructure    FeeStructure @relation(fields: [feeStructureId], references: [id])

  invoiceId       String?
  invoice         FeeInvoice? @relation(fields: [invoiceId], references: [id])

  amount          Decimal   @db.Decimal(10, 2)
  lateFee         Decimal   @default(0) @db.Decimal(10, 2)
  discount        Decimal   @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal   @db.Decimal(10, 2)

  paymentStatus   PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod?
  paymentDate     DateTime?
  transactionId   String?

  paidById        String?   // Parent who paid
  paidBy          Parent?   @relation(fields: [paidById], references: [id])

  forMonth        DateTime? @db.Date // For monthly fees
  remarks         String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([studentId])
  @@index([paymentStatus])
  @@index([receiptNo])
  @@index([invoiceId])
}

model FeeInvoice {
  id              String              @id @default(uuid())
  invoiceNo       String              @unique
  schoolId        String
  school          School              @relation(fields: [schoolId], references: [id])
  studentId       String
  student         Student             @relation(fields: [studentId], references: [id])
  lineItems       InvoiceLineItem[]
  payments        FeePayment[]
  subtotal        Decimal             @db.Decimal(10, 2)
  discount        Decimal             @default(0) @db.Decimal(10, 2)
  tax             Decimal             @default(0) @db.Decimal(10, 2)
  totalAmount     Decimal             @db.Decimal(10, 2)
  paidAmount      Decimal             @default(0) @db.Decimal(10, 2)
  dueDate         DateTime
  status          InvoiceStatus       @default(PENDING)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([schoolId])
  @@index([studentId])
  @@index([status])
}

model InvoiceLineItem {
  id              String        @id @default(uuid())
  invoiceId       String
  invoice         FeeInvoice    @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  feeStructureId  String
  feeStructure    FeeStructure  @relation(fields: [feeStructureId], references: [id])
  description     String
  quantity        Int           @default(1)
  unitPrice       Decimal       @db.Decimal(10, 2)
  amount          Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())

  @@index([invoiceId])
  @@index([feeStructureId])
}

// ==================== COMMUNICATION MODULE ====================

model Announcement {
  id              String    @id @default(uuid())
  title           String
  content         String    @db.Text
  
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])
  
  targetAudience  String[]  // ["ALL", "TEACHERS", "STUDENTS", "PARENTS"]
  targetClasses   String[]  // Class IDs, empty means all
  
  attachments     String[]
  isPublished     Boolean   @default(false)
  publishedAt     DateTime?
  expiresAt       DateTime?
  
  createdById     String
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([schoolId])
  @@index([isPublished])
}

model Message {
  id              String    @id @default(uuid())
  
  senderId        String
  sender          User      @relation("SentMessages", fields: [senderId], references: [id])
  
  receiverId      String
  receiver        User      @relation("ReceivedMessages", fields: [receiverId], references: [id])
  
  subject         String?
  content         String    @db.Text
  attachments     String[]
  
  isRead          Boolean   @default(false)
  readAt          DateTime?
  
  createdAt       DateTime  @default(now())

  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
}

model Notification {
  id              String    @id @default(uuid())
  
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  
  title           String
  body            String
  type            String    // ATTENDANCE, FEE, EXAM, ANNOUNCEMENT, etc.
  data            Json?     // Additional data
  
  isRead          Boolean   @default(false)
  readAt          DateTime?
  
  createdAt       DateTime  @default(now())

  @@index([userId, isRead])
  @@index([createdAt])
}

model Holiday {
  id              String    @id @default(uuid())

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  name            String
  date            DateTime  @db.Date
  description     String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([schoolId, date])
  @@index([schoolId])
  @@index([date])
}

// ==================== DOCUMENT AI MODULE ====================

enum DocumentStatus {
  UPLOADED
  PROCESSING
  COMPLETED
  FAILED
}

enum QuestionType {
  // Legacy types (kept for backward compatibility)
  MCQ
  TRUE_FALSE
  FILL_BLANK
  SHORT_ANSWER
  LONG_ANSWER
  MATCHING
  // New competitive exam types
  SINGLE_CORRECT       // Single correct answer MCQ (JEE/NEET style)
  MULTIPLE_CORRECT     // Multiple correct answers (JEE Advanced style)
  INTEGER_TYPE         // Numerical answer (JEE style)
  MATRIX_MATCH         // Matrix matching (JEE Advanced style)
  ASSERTION_REASONING  // Assertion-Reason type (NEET style)
  COMPREHENSION        // Passage-based linked questions
}

enum DifficultyLevel {
  EASY
  MEDIUM
  HARD
}

enum QuestionSource {
  EXTRACTED
  GENERATED
  MANUAL
  NCERT           // From NCERT textbooks
  PREVIOUS_YEAR   // Previous year exam questions
  IMPORTED        // Imported from external sources
}

// ==================== TEST PATTERN ENUMS ====================

enum PatternType {
  JEE_MAIN
  JEE_ADVANCED
  NEET
  CUSTOM
}

model UploadedDocument {
  id              String    @id @default(uuid())

  // File Info
  originalName    String
  fileName        String
  fileType        String    // pdf, docx, doc, txt, image
  fileSize        Int       // bytes
  storagePath     String

  // Classification
  subjectId       String?
  subject         Subject?  @relation(fields: [subjectId], references: [id])
  classId         String?
  class           Class?    @relation(fields: [classId], references: [id])
  chapter         String?
  language        String    @default("en")

  // Processing
  status          DocumentStatus @default(UPLOADED)
  processingStartedAt DateTime?
  processingCompletedAt DateTime?
  processingError String?

  // Results Summary
  pagesProcessed  Int       @default(0)
  questionsExtracted Int    @default(0)
  questionsGenerated Int    @default(0)

  // Uploader
  uploadedById    String
  uploadedBy      User      @relation(fields: [uploadedById], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  questions       Question[]

  @@index([subjectId, classId])
  @@index([status])
  @@index([uploadedById])
}

model Question {
  id              String    @id @default(uuid())

  // Question Content
  questionText    String    @db.Text
  questionHtml    String?   @db.Text
  questionImage   String?   // URL to image if any

  // Type and Metadata
  questionType    QuestionType
  difficulty      DifficultyLevel @default(MEDIUM)
  marks           Decimal   @default(1) @db.Decimal(5, 2)
  negativeMarks   Decimal   @default(0) @db.Decimal(5, 2)
  partialMarking  Boolean   @default(false) // For MULTIPLE_CORRECT type
  estimatedTime   Int       @default(60) // seconds

  // Classification
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  classId         String
  class           Class     @relation(fields: [classId], references: [id])

  // Chapter reference (now proper relation)
  chapterId       String?
  chapterRef      Chapter?  @relation(fields: [chapterId], references: [id])
  chapter         String?   // Legacy: chapter name as string (for backward compat)
  topic           String?
  tags            String[]

  // Answer - Generic
  correctAnswer   String?   // For SCQ: "a", for INTEGER: "42", for TRUE_FALSE: "true"
  options         Json?     // For SCQ/MCQ: [{id: "a", text: "Option 1", isCorrect: true/false}]
  answerExplanation String? @db.Text

  // Answer - Multiple Correct (MCQ with multiple answers)
  correctOptions  String[]  // For MULTIPLE_CORRECT: ["a", "c", "d"]

  // Answer - Integer Type
  integerAnswer   Int?      // For INTEGER_TYPE: exact answer
  integerRangeMin Int?      // Optional: minimum acceptable value
  integerRangeMax Int?      // Optional: maximum acceptable value

  // Answer - Matrix Match
  // Format: {leftColumn: [{id: "P", text: "..."}], rightColumn: [{id: "1", text: "..."}], correctMatches: {"P": ["1","2"], "Q": ["3"]}}
  matrixData      Json?

  // Answer - Assertion Reasoning
  // Format: {assertion: "text", reason: "text", correctOption: "a"}
  // Options are standard: A) Both true, R explains A; B) Both true, R doesn't explain; C) A true, R false; D) A false, R true
  assertionData   Json?

  // Comprehension/Passage Link
  comprehensionPassageId String?
  comprehensionPassage   ComprehensionPassage? @relation(fields: [comprehensionPassageId], references: [id])
  passageQuestionNumber  Int?    // Order within the passage

  // Source
  source          QuestionSource @default(MANUAL)
  sourceDocumentId String?
  sourceDocument  UploadedDocument? @relation(fields: [sourceDocumentId], references: [id])
  sourcePage      Int?
  sourceYear      Int?      // For previous year questions
  sourceExam      String?   // "JEE Main 2023", "NEET 2022" etc.
  confidence      Decimal?  @db.Decimal(3, 2) // AI confidence 0-1

  // Review Status
  isVerified      Boolean   @default(false)
  verifiedById    String?
  verifiedAt      DateTime?

  // Creator
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  testQuestions   TestQuestion[]

  // Study Planner
  dayAttemptResponses DayAttemptResponse[]

  @@index([subjectId, classId])
  @@index([questionType])
  @@index([difficulty])
  @@index([source])
  @@index([isVerified])
  @@index([chapterId])
  @@index([comprehensionPassageId])
}

// ==================== TEST PATTERN MODULE ====================

model TestPattern {
  id              String      @id @default(uuid())
  name            String      // "JEE Main 2024", "NEET Pattern", "Custom Quiz"
  description     String?     @db.Text

  patternType     PatternType @default(CUSTOM)
  isDefault       Boolean     @default(false) // System defaults like JEE/NEET

  // Optional: Lock to specific subject (null = any subject)
  subjectId       String?
  subject         Subject?    @relation(fields: [subjectId], references: [id])

  // Pattern Configuration
  // Format: Array of sections with question type quotas and marks
  // [{
  //   name: "Physics",
  //   subjectCode: "PHY",
  //   questionTypes: [
  //     { type: "SINGLE_CORRECT", count: 20, marksPerQuestion: 4, negativeMarks: 1 },
  //     { type: "INTEGER_TYPE", count: 5, marksPerQuestion: 4, negativeMarks: 0 }
  //   ],
  //   totalMarks: 100,
  //   duration: 60
  // }]
  sections        Json

  // Scoring Rules
  // Format: { "SINGLE_CORRECT": { marks: 4, negative: 1 }, "MULTIPLE_CORRECT": { marks: 4, negative: 2, partial: true } }
  scoringRules    Json

  // Total configuration (computed from sections but stored for quick access)
  totalMarks      Decimal     @db.Decimal(6, 2)
  totalQuestions  Int
  totalDuration   Int         // Total duration in minutes

  // Creator (null for system defaults)
  createdById     String?

  isActive        Boolean     @default(true)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  // Relations
  tests           OnlineTest[]

  @@index([patternType])
  @@index([isDefault])
}

// ==================== ONLINE TEST MODULE ====================

enum TestStatus {
  DRAFT
  PUBLISHED
  ACTIVE
  CLOSED
  ARCHIVED
}

enum TestType {
  PRACTICE
  GRADED
  MOCK
  ASSIGNMENT
  COMPETITIVE    // For JEE/NEET style tests
}

enum AttemptStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  GRADED
  ABANDONED
}

model OnlineTest {
  id              String    @id @default(uuid())

  title           String
  description     String?   @db.Text
  instructions    String?   @db.Text

  // Classification
  testType        TestType  @default(PRACTICE)
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  sectionId       String?   // null = all sections
  section         Section?  @relation(fields: [sectionId], references: [id])

  // Pattern Reference (optional - for pattern-based tests)
  patternId       String?
  pattern         TestPattern? @relation(fields: [patternId], references: [id])

  // Configuration
  totalMarks      Decimal   @db.Decimal(6, 2)
  passingMarks    Decimal?  @db.Decimal(6, 2)
  durationMinutes Int
  totalQuestions  Int

  // Scheduling
  startDateTime   DateTime?
  endDateTime     DateTime?
  validityEndDateTime DateTime? // When test link expires (separate from end time)
  allowLateSubmission Boolean @default(false)
  lateSubmissionPenalty Decimal @default(0) @db.Decimal(5, 2)

  // Settings
  shuffleQuestions Boolean  @default(true)
  shuffleOptions  Boolean   @default(true)
  showResultsImmediately Boolean @default(false)
  showCorrectAnswers Boolean @default(false)
  allowReview     Boolean   @default(true)
  maxAttempts     Int       @default(1)
  requireWebcam   Boolean   @default(false)

  // Section-wise question allocation (for pattern-based tests)
  // Format: [{ sectionName: "Physics", questionIds: ["...", "..."], marks: 100 }]
  sectionConfig   Json?

  // Status
  status          TestStatus @default(DRAFT)
  publishedAt     DateTime?

  // Creator
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  questions       TestQuestion[]
  attempts        TestAttempt[]

  @@index([subjectId, classId])
  @@index([status])
  @@index([startDateTime, endDateTime])
  @@index([patternId])
}

model TestQuestion {
  id              String    @id @default(uuid())

  testId          String
  test            OnlineTest @relation(fields: [testId], references: [id], onDelete: Cascade)

  questionId      String
  question        Question  @relation(fields: [questionId], references: [id])

  sequenceOrder   Int
  marks           Decimal   @db.Decimal(5, 2)
  negativeMarks   Decimal   @default(0) @db.Decimal(5, 2)

  createdAt       DateTime  @default(now())

  // Relations
  responses       TestResponse[]

  @@unique([testId, questionId])
  @@unique([testId, sequenceOrder])
  @@index([testId])
}

model TestAttempt {
  id              String    @id @default(uuid())

  testId          String
  test            OnlineTest @relation(fields: [testId], references: [id])

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])

  attemptNumber   Int       @default(1)

  // Timing
  startedAt       DateTime  @default(now())
  submittedAt     DateTime?
  timeTakenSeconds Int?

  // Scoring
  totalScore      Decimal?  @db.Decimal(5, 2)
  percentage      Decimal?  @db.Decimal(5, 2)
  questionsAnswered Int     @default(0)
  correctAnswers  Int       @default(0)

  // Status
  status          AttemptStatus @default(IN_PROGRESS)

  // Proctoring
  proctoringFlags Json?     // [{type: "tab_switch", timestamp: "..."}]
  ipAddress       String?
  userAgent       String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  responses       TestResponse[]

  @@unique([testId, studentId, attemptNumber])
  @@index([testId])
  @@index([studentId])
  @@index([status])
}

model TestResponse {
  id              String    @id @default(uuid())

  attemptId       String
  attempt         TestAttempt @relation(fields: [attemptId], references: [id], onDelete: Cascade)

  testQuestionId  String
  testQuestion    TestQuestion @relation(fields: [testQuestionId], references: [id])

  // Response
  responseText    String?   @db.Text
  selectedOptions Json?     // ["a", "c"] for MCQ

  // Grading
  marksObtained   Decimal?  @db.Decimal(5, 2)
  isCorrect       Boolean?
  autoGraded      Boolean   @default(false)
  gradedById      String?
  gradingRemarks  String?

  // Metadata
  timeSpentSeconds Int?
  answeredAt      DateTime?
  flaggedForReview Boolean  @default(false)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([attemptId, testQuestionId])
  @@index([attemptId])
}

// ==================== ASSIGNMENT MODULE ====================

enum AssignmentStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum SubmissionStatus {
  NOT_SUBMITTED
  SUBMITTED
  LATE
  GRADED
  RETURNED
}

model Assignment {
  id              String    @id @default(uuid())

  title           String
  description     String?   @db.Text
  instructions    String?   @db.Text

  // Classification
  subjectId       String
  subject         Subject   @relation(fields: [subjectId], references: [id])
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  sectionId       String?
  section         Section?  @relation(fields: [sectionId], references: [id])

  // Attachments
  attachments     String[]  // File URLs

  // Dates
  assignedDate    DateTime  @default(now())
  dueDate         DateTime
  allowLateSubmission Boolean @default(true)
  latePenaltyPerDay Decimal @default(0) @db.Decimal(5, 2)

  // Grading
  totalMarks      Decimal?  @db.Decimal(5, 2)
  gradingRubric   Json?     // Structured rubric

  // Status
  status          AssignmentStatus @default(DRAFT)

  // Creator
  createdById     String
  createdBy       User      @relation(fields: [createdById], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  submissions     AssignmentSubmission[]

  @@index([subjectId, classId])
  @@index([dueDate])
  @@index([status])
}

model AssignmentSubmission {
  id              String    @id @default(uuid())

  assignmentId    String
  assignment      Assignment @relation(fields: [assignmentId], references: [id])

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])

  // Submission
  submissionText  String?   @db.Text
  attachments     String[]  // File URLs

  submittedAt     DateTime  @default(now())
  isLate          Boolean   @default(false)

  // Grading
  marksObtained   Decimal?  @db.Decimal(5, 2)
  percentage      Decimal?  @db.Decimal(5, 2)
  grade           String?
  feedback        String?   @db.Text
  gradedById      String?
  gradedAt        DateTime?

  // Plagiarism
  plagiarismScore Decimal?  @db.Decimal(5, 2)
  plagiarismReport String?

  // Status
  status          SubmissionStatus @default(SUBMITTED)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([assignmentId, studentId])
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
}

// ==================== LIBRARY/BOOKS MODULE ====================

enum BookSourceType {
  LOCAL_FILE
  EXTERNAL_URL
}

enum BookStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum AnnotationType {
  HIGHLIGHT
  NOTE
  FREEHAND
  SHAPE
  STAMP
  BOOKMARK
}

// Book Category - Hierarchical structure (NCERT > Class > Subject > Chapter)
model BookCategory {
  id              String    @id @default(uuid())
  name            String
  description     String?   @db.Text

  // Self-referential for hierarchy
  parentId        String?
  parent          BookCategory? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children        BookCategory[] @relation("CategoryHierarchy")

  // NCERT specific metadata
  boardType       String?   // "NCERT", "CBSE", "State Board"
  classLevel      String?   // "10", "11", "12"
  subjectCode     String?   // "PHY", "CHEM", "MATH"

  displayOrder    Int       @default(0)
  iconName        String?   // Lucide icon name for UI
  color           String?   // Theme color hex

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  books           Book[]

  @@index([parentId])
  @@index([schoolId])
  @@index([boardType, classLevel])
}

model Book {
  id              String    @id @default(uuid())
  title           String
  description     String?   @db.Text
  author          String?
  publisher       String?
  publicationYear Int?
  isbn            String?
  coverImage      String?   // Path to cover image

  // Source Type
  sourceType      BookSourceType

  // For LOCAL_FILE
  fileName        String?
  originalName    String?
  fileSize        Int?      // bytes
  storagePath     String?   // uploads/books/{uuid}.pdf
  mimeType        String?
  pageCount       Int?

  // For EXTERNAL_URL
  externalUrl     String?   // Google Drive link, etc.
  externalProvider String?  // "google_drive", "onedrive", "dropbox"

  // Classification
  categoryId      String
  category        BookCategory @relation(fields: [categoryId], references: [id])

  // NCERT specific
  chapterNumber   Int?
  classLevel      String?

  subjectId       String?
  subject         Subject?  @relation(fields: [subjectId], references: [id])

  // AI Processing
  isIndexed       Boolean   @default(false) // Text extracted for AI
  textContent     String?   @db.Text        // Extracted text for search
  indexedAt       DateTime?

  // Status
  status          BookStatus @default(DRAFT)
  viewCount       Int       @default(0)
  downloadCount   Int       @default(0)

  // Metadata
  tags            String[]
  language        String    @default("en")

  // School & Uploader
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  uploadedById    String
  uploadedBy      User      @relation("UploadedBooks", fields: [uploadedById], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  bookAccess      BookAccess[]
  bookQA          BookQA[]
  bookAnnotations BookAnnotation[]
  chapters        BookChapter[]

  // Practice MCQ
  practiceQuestions PracticeQuestion[]
  practiceSessions  PracticeSession[]

  @@index([categoryId])
  @@index([subjectId])
  @@index([schoolId])
  @@index([status])
  @@index([uploadedById])
}

// Book Chapters (Table of Contents)
model BookChapter {
  id              String    @id @default(uuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  title           String
  chapterNumber   Int
  startPage       Int
  endPage         Int?
  description     String?

  // Link to curriculum chapter if applicable
  curriculumChapterId String?
  curriculumChapter   Chapter? @relation(fields: [curriculumChapterId], references: [id])

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([bookId, chapterNumber])
  @@index([bookId])
}

// Access Control - Which batches can see which books
model BookAccess {
  id              String    @id @default(uuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Can be assigned to:
  // - Class only (all sections)
  // - Class + Section (specific batch)
  classId         String
  class           Class     @relation(fields: [classId], references: [id])
  sectionId       String?   // null = all sections of the class
  section         Section?  @relation(fields: [sectionId], references: [id])

  // Academic year context
  academicYearId  String?
  academicYear    AcademicYear? @relation(fields: [academicYearId], references: [id])

  // Permissions
  canDownload     Boolean   @default(true)
  canAnnotate     Boolean   @default(true)

  // Visibility dates
  availableFrom   DateTime?
  availableUntil  DateTime?

  createdById     String
  createdAt       DateTime  @default(now())

  @@unique([bookId, classId, sectionId, academicYearId])
  @@index([classId, sectionId])
  @@index([bookId])
}

// AI Q&A with Hybrid Caching
model BookQA {
  id              String    @id @default(uuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // The question asked
  question        String    @db.Text
  questionHash    String    // MD5/SHA hash for exact match lookup

  // AI Generated Answer
  answer          String    @db.Text
  answerHtml      String?   @db.Text  // Formatted with markdown

  // Source references
  sourcePages     Int[]     // Pages referenced in answer
  sourceChunks    String[]  // Text chunks used (for citations)
  confidence      Decimal   @db.Decimal(3, 2)  // 0-1 confidence score

  // Token tracking
  promptTokens    Int?
  completionTokens Int?
  totalTokens     Int?
  model           String?   // "claude-3-haiku", etc.

  // Usage stats
  useCount        Int       @default(1)
  lastUsedAt      DateTime  @default(now())

  // Who asked first
  askedById       String
  askedBy         User      @relation("BookQAAsked", fields: [askedById], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookId])
  @@index([questionHash])
  @@index([useCount])
}

// PDF Annotations with Full Canvas Support
model BookAnnotation {
  id              String    @id @default(uuid())
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Owner
  userId          String
  user            User      @relation("BookAnnotations", fields: [userId], references: [id], onDelete: Cascade)

  // Page location
  pageNumber      Int

  // Annotation Type
  annotationType  AnnotationType

  // For highlights/text selection
  selectedText    String?   @db.Text
  textRanges      Json?     // [{start: {index, offset}, end: {index, offset}}]
  highlightColor  String?   // hex color

  // For notes/text boxes
  noteContent     String?   @db.Text
  notePosition    Json?     // {x, y, width, height}

  // For freehand drawing
  drawingPaths    Json?     // SVG path data or fabric.js serialized
  strokeColor     String?
  strokeWidth     Int?

  // For shapes (rectangles, circles, arrows)
  shapeType       String?   // "rectangle", "circle", "arrow", "line"
  shapeData       Json?     // {x, y, width, height, radius, points, etc.}
  fillColor       String?

  // For stamps/icons
  stampType       String?   // "important", "question", "bookmark"

  // Canvas layer data (full fabric.js/canvas state)
  canvasState     Json?     // Serialized canvas for complex annotations

  // Visibility
  isPrivate       Boolean   @default(true) // Only visible to owner
  isShared        Boolean   @default(false) // Shared with class

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([bookId, userId])
  @@index([bookId, pageNumber])
}

// Bulk Upload Job Tracking
model BookUploadJob {
  id              String    @id @default(uuid())

  // Job metadata
  folderName      String
  totalFiles      Int
  processedFiles  Int       @default(0)
  successCount    Int       @default(0)
  failureCount    Int       @default(0)

  // Target category
  categoryId      String
  classLevel      String?
  subjectId       String?

  // School
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  // Status
  status          String    @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  errorLog        Json?     // [{fileName, error}]

  // Timestamps
  startedAt       DateTime?
  completedAt     DateTime?

  uploadedById    String
  createdAt       DateTime  @default(now())

  @@index([status])
  @@index([schoolId])
  @@index([uploadedById])
}

// ==================== ADMIN MASTER DATA MODULE ====================

// Branch - School Campus Unit
model Branch {
  id              String    @id @default(uuid())
  name            String    // "Main Campus", "South Campus"
  code            String    // "MAIN", "SOUTH"
  address         String?
  city            String?
  state           String?
  pincode         String?
  phone           String?
  email           String?

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  classes         Class[]
  teachers        Teacher[]
  students        Student[]

  // Transportation
  vehicles        Vehicle[]
  drivers         Driver[]
  routes          Route[]
  stops           Stop[]

  @@unique([schoolId, code])
  @@index([schoolId])
}

// Tag - Question Tags Master Data
model Tag {
  id              String    @id @default(uuid())
  name            String
  slug            String    // normalized for search
  category        String?   // "topic", "concept", "skill"
  color           String?   // hex color for UI

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // YouTube Videos
  videos          VideoTag[]

  @@unique([schoolId, slug])
  @@index([schoolId])
  @@index([category])
}

// AssessmentReason - Administrative Assessment Categories
model AssessmentReason {
  id              String    @id @default(uuid())
  name            String    // "Scholarship Evaluation", "Promotion Review"
  code            String
  description     String?

  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id])

  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([schoolId, code])
  @@index([schoolId])
}

// Task - Admin Task Management
model Task {
  id              String       @id @default(uuid())
  title           String
  description     String?      @db.Text

  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id])

  // Assignment
  assignedToId    String?
  assignedTo      User?        @relation("TaskAssignee", fields: [assignedToId], references: [id])
  createdById     String
  createdBy       User         @relation("TaskCreator", fields: [createdById], references: [id])

  // Dates
  dueDate         DateTime?
  completedAt     DateTime?

  // Status
  status          TaskStatus   @default(PENDING)
  priority        TaskPriority @default(MEDIUM)
  category        String?      // "fee_collection", "parent_meeting", "report"

  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([schoolId])
  @@index([assignedToId])
  @@index([status])
  @@index([dueDate])
  @@index([priority])
}

// BatchTransfer - Student Batch Transfer Audit Trail
model BatchTransfer {
  id              String    @id @default(uuid())

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id])

  fromClassId     String
  fromSectionId   String
  toClassId       String
  toSectionId     String

  reason          String?
  effectiveDate   DateTime  @default(now())

  transferredById String
  transferredBy   User      @relation(fields: [transferredById], references: [id])

  createdAt       DateTime  @default(now())

  @@index([studentId])
  @@index([effectiveDate])
  @@index([transferredById])
}

// ==================== PRACTICE MCQ MODULE ====================

enum PracticeDifficulty {
  EASY
  MEDIUM
  HARD
}

enum PracticeMode {
  READING
  TEST
}

enum PracticeQuestionStatus {
  ACTIVE
  ARCHIVED
}

enum ExamPattern {
  NEET
  JEE
  GENERAL
}

// Practice questions generated from book content (per-book, shared across students)
model PracticeQuestion {
  id              String    @id @default(uuid())

  // Link to book
  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Question content
  questionText    String    @db.Text
  questionHtml    String?   @db.Text

  // Options as JSON array: [{id: "a", text: "Option 1"}, ...]
  options         Json

  // Correct answer (option id: "a", "b", "c", or "d")
  correctAnswer   String

  // Explanation shown after answering
  explanation     String?   @db.Text

  // Difficulty and timing
  difficulty      PracticeDifficulty @default(MEDIUM)
  timeSeconds     Int       @default(90) // 60 for easy, 90 for medium, 120 for hard

  // Chapter and exam pattern tracking
  chapterIndex    Int?      // Chapter number (0-indexed)
  chapterName     String?   // Chapter title/name
  examPattern     ExamPattern @default(GENERAL)

  // Source tracking (for context extraction)
  sourcePageStart Int?      // Starting page from book
  sourcePageEnd   Int?      // Ending page from book
  sourceChunk     String?   @db.Text  // Text chunk used for generation

  // AI generation metadata
  generatedAt     DateTime  @default(now())
  batchId         String?   // Group questions from same generation batch
  confidence      Decimal?  @db.Decimal(3, 2) // AI confidence 0-1

  status          PracticeQuestionStatus @default(ACTIVE)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  attempts        PracticeAttempt[]

  @@index([bookId])
  @@index([difficulty])
  @@index([status])
  @@index([batchId])
  @@index([chapterIndex])
  @@index([examPattern])
  @@index([bookId, chapterIndex, examPattern])
}

// Track individual student attempts on practice questions
model PracticeAttempt {
  id              String    @id @default(uuid())

  questionId      String
  question        PracticeQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Response
  selectedAnswer  String?   // The option id selected ("a", "b", "c", "d")
  isCorrect       Boolean?

  // Timing
  timeSpentSeconds Int?
  attemptedAt     DateTime  @default(now())

  // Context: which session this was part of
  sessionId       String?
  session         PracticeSession? @relation(fields: [sessionId], references: [id])

  @@unique([questionId, studentId, sessionId])
  @@index([studentId])
  @@index([questionId])
  @@index([sessionId])
}

// Track practice sessions (for Test Mode)
model PracticeSession {
  id              String    @id @default(uuid())

  studentId       String
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  bookId          String
  book            Book      @relation(fields: [bookId], references: [id], onDelete: Cascade)

  // Session configuration
  mode            PracticeMode
  questionCount   Int       // 10, 20, 30, or 50

  // Timing (for Test Mode)
  totalTimeSeconds Int?     // Calculated from questions
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  // Results (for Test Mode)
  score           Int?      // Correct answers count
  totalQuestions  Int

  // Question order (JSON array of questionIds)
  questionOrder   Json?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  attempts        PracticeAttempt[]

  @@index([studentId])
  @@index([bookId])
  @@index([mode])
}

// ==================== STUDY PLANNER MODULE ====================

enum StudyPlanStatus {
  DRAFT
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
}

enum StudyDayStatus {
  LOCKED
  UNLOCKED
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum DayAttemptStatus {
  IN_PROGRESS
  PASSED
  FAILED
  COOLDOWN
}

// Main Study Plan
model StudyPlan {
  id                    String          @id @default(uuid())

  // Student reference
  studentId             String
  student               Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Subject & Chapter
  subjectId             String
  subject               Subject         @relation(fields: [subjectId], references: [id])
  chapterId             String
  chapter               Chapter         @relation(fields: [chapterId], references: [id])

  // AI-Recommended Study Plan
  diagnosticScore       Decimal?        @db.Decimal(5, 2)  // Initial assessment score
  weakAreas             Json?           // [{topic: "...", score: 0-100}]
  aiRecommendedHours    Decimal         @db.Decimal(5, 2)  // Total hours recommended by AI
  aiAnalysis            Json?           // Full AI analysis response

  // Student's chosen plan
  totalDays             Int             // Number of days chosen (e.g., 4)
  hoursPerDay           Decimal         @db.Decimal(4, 2)  // aiRecommendedHours / totalDays
  startDate             DateTime        @default(now())
  targetEndDate         DateTime

  // Progress tracking
  currentDay            Int             @default(1)
  totalTimeSpentMinutes Int             @default(0)
  status                StudyPlanStatus @default(ACTIVE)
  completedAt           DateTime?

  // Metadata
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt

  // Relations
  studyDays             StudyPlanDay[]

  @@index([studentId])
  @@index([subjectId, chapterId])
  @@index([status])
}

// Individual Day Tile
model StudyPlanDay {
  id                      String          @id @default(uuid())

  studyPlanId             String
  studyPlan               StudyPlan       @relation(fields: [studyPlanId], references: [id], onDelete: Cascade)

  dayNumber               Int             // 1, 2, 3, 4...
  status                  StudyDayStatus  @default(LOCKED)

  // Content assignments
  youtubeVideoIds         String[]        // Assigned videos for this day
  bookContentPageStart    Int?            // Book page range start
  bookContentPageEnd      Int?            // Book page range end
  practiceQuestionIds     String[]        // Assigned practice questions
  summaryNotes            String?         @db.Text  // AI-generated summary notes

  // Timing
  estimatedMinutes        Int             // Estimated time for this day
  actualTimeSpentMinutes  Int             @default(0)

  // Progress tracking
  videosWatched           Int             @default(0)
  videosTotal             Int             @default(0)
  readingCompleted        Boolean         @default(false)
  practiceCompleted       Boolean         @default(false)

  // Test gate
  requiredPassPercent     Int             @default(80)  // 80% for first attempt
  currentPassRequirement  Int             @default(80)  // Changes to 100 on reattempt

  // Unlock mechanics
  unlockedAt              DateTime?
  completedAt             DateTime?
  nextAttemptAt           DateTime?       // For cooldown after failure

  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt

  // Relations
  dayAttempts             DayAttempt[]
  videoProgress           DayVideoProgress[]

  @@unique([studyPlanId, dayNumber])
  @@index([studyPlanId])
  @@index([status])
}

// Day Test Attempt
model DayAttempt {
  id                String            @id @default(uuid())

  studyDayId        String
  studyDay          StudyPlanDay      @relation(fields: [studyDayId], references: [id], onDelete: Cascade)

  attemptNumber     Int               @default(1)

  // Test configuration
  questionCount     Int               @default(10)
  passingPercent    Int               // 80 or 100

  // Results
  totalScore        Decimal?          @db.Decimal(5, 2)
  percentage        Decimal?          @db.Decimal(5, 2)
  correctAnswers    Int               @default(0)

  // Timing
  startedAt         DateTime          @default(now())
  submittedAt       DateTime?
  timeTakenSeconds  Int?

  status            DayAttemptStatus  @default(IN_PROGRESS)
  cooldownEndsAt    DateTime?         // When student can reattempt

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // Relations
  responses         DayAttemptResponse[]

  @@index([studyDayId])
  @@index([status])
}

// Individual question responses in day test
model DayAttemptResponse {
  id               String      @id @default(uuid())

  dayAttemptId     String
  dayAttempt       DayAttempt  @relation(fields: [dayAttemptId], references: [id], onDelete: Cascade)

  questionId       String
  question         Question    @relation(fields: [questionId], references: [id])

  selectedAnswer   String?
  isCorrect        Boolean?
  timeSpentSeconds Int?

  createdAt        DateTime    @default(now())

  @@unique([dayAttemptId, questionId])
  @@index([dayAttemptId])
}

// Video progress within a day
model DayVideoProgress {
  id                   String        @id @default(uuid())

  studyDayId           String
  studyDay             StudyPlanDay  @relation(fields: [studyDayId], references: [id], onDelete: Cascade)

  youtubeVideoId       String
  video                YouTubeVideo  @relation(fields: [youtubeVideoId], references: [id])

  watchedSeconds       Int           @default(0)
  totalDurationSeconds Int?
  isCompleted          Boolean       @default(false)
  completedAt          DateTime?

  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@unique([studyDayId, youtubeVideoId])
  @@index([studyDayId])
}

// ==================== YOUTUBE VIDEO LEARNING MODULE ====================

enum VideoStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// YouTube Video - Core video entity
model YouTubeVideo {
  id              String       @id @default(uuid())

  // YouTube metadata
  youtubeUrl      String       // Full YouTube URL (stored but hidden from students)
  youtubeVideoId  String       // Extracted video ID (11 chars)
  title           String
  description     String?      @db.Text
  thumbnailUrl    String?
  duration        Int?         // Duration in seconds

  // Classification
  subjectId       String?
  subject         Subject?     @relation(fields: [subjectId], references: [id])

  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id])

  // Status
  status          VideoStatus  @default(DRAFT)
  publishedAt     DateTime?

  // Creator
  createdById     String
  createdBy       User         @relation("VideoCreator", fields: [createdById], references: [id])

  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  videoAccess      VideoAccess[]
  videoTags        VideoTag[]
  comprehensionQuestions VideoComprehensionQuestion[]
  watchSessions    VideoWatchSession[]

  // Study Planner
  dayVideoProgress DayVideoProgress[]

  @@index([schoolId])
  @@index([youtubeVideoId])
  @@index([status])
  @@index([subjectId])
}

// Video Access - Batch-level access control
model VideoAccess {
  id              String       @id @default(uuid())
  videoId         String
  video           YouTubeVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Assigned to batch
  classId         String
  class           Class        @relation(fields: [classId], references: [id])
  sectionId       String?      // null = all sections
  section         Section?     @relation(fields: [sectionId], references: [id])

  academicYearId  String?
  academicYear    AcademicYear? @relation(fields: [academicYearId], references: [id])

  // Visibility dates
  availableFrom   DateTime?
  availableUntil  DateTime?

  createdById     String
  createdAt       DateTime     @default(now())

  @@unique([videoId, classId, sectionId, academicYearId])
  @@index([classId, sectionId])
  @@index([videoId])
}

// Video Tags - Many-to-many relationship for tag folders
model VideoTag {
  id              String       @id @default(uuid())
  videoId         String
  video           YouTubeVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)
  tagId           String
  tag             Tag          @relation(fields: [tagId], references: [id])

  createdAt       DateTime     @default(now())

  @@unique([videoId, tagId])
  @@index([tagId])
}

// Comprehension Questions - Per-video questions
model VideoComprehensionQuestion {
  id              String       @id @default(uuid())
  videoId         String
  video           YouTubeVideo @relation(fields: [videoId], references: [id], onDelete: Cascade)

  // Question content
  questionText    String       @db.Text
  options         Json         // [{id: "a", text: "..."}, {id: "b", text: "..."}, ...]
  correctAnswer   String       // "a", "b", "c", "d"
  explanation     String?      @db.Text

  // Source
  isAIGenerated   Boolean      @default(false)
  sequenceOrder   Int          @default(0)

  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  responses       VideoQuestionResponse[]

  @@index([videoId])
}

// Watch Session - Tracks a student's video viewing session
model VideoWatchSession {
  id              String       @id @default(uuid())
  videoId         String
  video           YouTubeVideo @relation(fields: [videoId], references: [id])
  studentId       String
  student         Student      @relation(fields: [studentId], references: [id])

  // Timing
  startedAt       DateTime     @default(now())
  endedAt         DateTime?
  totalWatchTimeSeconds Int    @default(0) // Cumulative watch time
  lastPositionSeconds   Int    @default(0) // Last video position

  // Engagement tracking
  verificationsCompleted Int   @default(0) // 5-min verification count
  verificationsFailed    Int   @default(0) // Failed verifications
  questionsAnswered      Int   @default(0)
  questionsCorrect       Int   @default(0)

  // Session status
  isCompleted     Boolean      @default(false)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  verifications   VideoVerification[]
  questionResponses VideoQuestionResponse[]

  @@index([studentId])
  @@index([videoId])
  @@index([studentId, videoId])
}

// Video Verification - 5-minute word typing verification
model VideoVerification {
  id              String       @id @default(uuid())
  sessionId       String
  session         VideoWatchSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // Verification details
  wordShown       String       // Random word shown to student
  wordEntered     String?      // What student typed
  isCorrect       Boolean      @default(false)

  // When it happened (in video timeline)
  atVideoSeconds  Int          // Video position when verification was triggered

  respondedAt     DateTime?
  createdAt       DateTime     @default(now())

  @@index([sessionId])
}

// Video Question Response - 30-minute comprehension responses
model VideoQuestionResponse {
  id              String       @id @default(uuid())
  sessionId       String
  session         VideoWatchSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  questionId      String
  question        VideoComprehensionQuestion @relation(fields: [questionId], references: [id])

  // Response
  selectedAnswer  String?
  isCorrect       Boolean?

  // When it happened
  atVideoSeconds  Int          // Video position when question was triggered
  answeredAt      DateTime?

  createdAt       DateTime     @default(now())

  @@unique([sessionId, questionId])
  @@index([sessionId])
  @@index([questionId])
}

// ==================== TRANSPORTATION MODULE ====================

// Transportation Enums
enum VehicleType {
  BUS
  VAN
  CAR
  AUTO
  TEMPO
}

enum VehicleStatus {
  ACTIVE
  MAINTENANCE
  OUT_OF_SERVICE
  RETIRED
}

enum DriverStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  RESIGNED
}

enum RouteStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum StopType {
  PICKUP
  DROP
  BOTH
}

enum MaintenanceType {
  ROUTINE
  REPAIR
  INSPECTION
  BREAKDOWN
  ACCIDENT
}

enum MaintenanceStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum GPSStatus {
  ONLINE
  OFFLINE
  INACTIVE
}

enum TripStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ==================== VEHICLE & DRIVER MODELS ====================

model Vehicle {
  id              String        @id @default(uuid())
  registrationNumber String      @unique
  type            VehicleType
  capacity        Int           // Seating capacity
  gpsDeviceId     String?       // GPS device identifier

  status          VehicleStatus @default(ACTIVE)
  purchaseDate    DateTime?

  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id])

  branchId        String?
  branch          Branch?       @relation(fields: [branchId], references: [id])

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  routeVehicles   RouteVehicle[]
  vehicleDrivers  VehicleDriver[]
  trips           Trip[]
  gpsLocations    GPSLocation[]
  maintenanceLogs VehicleMaintenanceLog[]

  @@index([schoolId])
  @@index([branchId])
  @@index([status])
}

model Driver {
  id              String        @id @default(uuid())

  // Link to User (Teacher who is also a driver)
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  licenseNumber   String        @unique
  licenseExpiry   DateTime
  phone           String

  status          DriverStatus  @default(ACTIVE)

  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id])

  branchId        String?
  branch          Branch?       @relation(fields: [branchId], references: [id])

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  vehicleAssignments VehicleDriver[]
  routeAssignments RouteDriver[]
  trips           Trip[]

  @@index([schoolId])
  @@index([branchId])
  @@index([status])
}

// ==================== ROUTE & STOP MODELS ====================

model Route {
  id              String        @id @default(uuid())
  name            String
  description     String?

  startTime       String        // "08:00"
  endTime         String        // "09:00"

  status          RouteStatus   @default(ACTIVE)

  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id])

  branchId        String?
  branch          Branch?       @relation(fields: [branchId], references: [id])

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  stops           RouteStop[]
  vehicleAssignments RouteVehicle[]
  driverAssignments RouteDriver[]
  studentAssignments StudentRoute[]
  trips           Trip[]

  @@index([schoolId])
  @@index([branchId])
  @@index([status])
}

model Stop {
  id              String        @id @default(uuid())
  name            String
  latitude        Decimal       @db.Decimal(10, 8)
  longitude       Decimal       @db.Decimal(11, 8)
  stopType        StopType
  address         String?

  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id])

  branchId        String?
  branch          Branch?       @relation(fields: [branchId], references: [id])

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  routes          RouteStop[]
  pickupStudents  StudentRoute[] @relation("PickupStop")
  dropStudents    StudentRoute[] @relation("DropStop")

  @@index([schoolId])
  @@index([branchId])
}

model RouteStop {
  id              String        @id @default(uuid())

  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)

  stopId          String
  stop            Stop          @relation(fields: [stopId], references: [id])

  sequence        Int           // Order in route (1, 2, 3, etc.)
  waitTimeMinutes Int           @default(5)

  createdAt       DateTime      @default(now())

  @@unique([routeId, stopId])
  @@unique([routeId, sequence])
  @@index([routeId])
}

// ==================== ROUTE ASSIGNMENT MODELS ====================

model RouteVehicle {
  id              String        @id @default(uuid())

  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)

  vehicleId       String
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  effectiveFrom   DateTime      @default(now())
  effectiveTo     DateTime?

  createdAt       DateTime      @default(now())

  @@unique([routeId, vehicleId])
  @@index([routeId])
  @@index([vehicleId])
}

model RouteDriver {
  id              String        @id @default(uuid())

  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)

  driverId        String
  driver          Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)

  effectiveFrom   DateTime      @default(now())
  effectiveTo     DateTime?

  createdAt       DateTime      @default(now())

  @@unique([routeId, driverId])
  @@index([routeId])
  @@index([driverId])
}

model VehicleDriver {
  id              String        @id @default(uuid())

  vehicleId       String
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  driverId        String
  driver          Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)

  assignedDate    DateTime      @default(now())
  unassignedDate  DateTime?

  createdAt       DateTime      @default(now())

  @@unique([vehicleId, driverId])
  @@index([vehicleId])
  @@index([driverId])
}

// ==================== STUDENT ROUTE ASSIGNMENT ====================

model StudentRoute {
  id              String        @id @default(uuid())

  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  routeId         String
  route           Route         @relation(fields: [routeId], references: [id], onDelete: Cascade)

  pickupStopId    String
  pickupStop      Stop          @relation("PickupStop", fields: [pickupStopId], references: [id])

  dropStopId      String
  dropStop        Stop          @relation("DropStop", fields: [dropStopId], references: [id])

  boardingTime    String?       // Expected boarding time "08:15"
  alightingTime   String?       // Expected alighting time "09:00"

  consentToTracking Boolean     @default(true)

  isActive        Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  tripRecords     StudentTripRecord[]

  @@unique([studentId, routeId])
  @@index([routeId])
  @@index([studentId])
}

// ==================== TRIP & TRACKING MODELS ====================

model Trip {
  id              String        @id @default(uuid())

  routeId         String
  route           Route         @relation(fields: [routeId], references: [id])

  vehicleId       String
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id])

  driverId        String
  driver          Driver        @relation(fields: [driverId], references: [id])

  tripDate        DateTime      @db.Date
  startTime       DateTime?     // Actual start time
  endTime         DateTime?     // Actual end time

  status          TripStatus    @default(SCHEDULED)

  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id])

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  studentRecords  StudentTripRecord[]

  @@index([routeId])
  @@index([vehicleId])
  @@index([driverId])
  @@index([tripDate])
  @@index([status])
  @@index([schoolId])
}

model StudentTripRecord {
  id              String        @id @default(uuid())

  tripId          String
  trip            Trip          @relation(fields: [tripId], references: [id], onDelete: Cascade)

  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  studentRouteId  String
  studentRoute    StudentRoute  @relation(fields: [studentRouteId], references: [id])

  boarded         Boolean       @default(false)
  boardingTime    DateTime?
  boardingPhoto   String?       // Photo URL

  alighted        Boolean       @default(false)
  alightingTime   DateTime?
  alightingPhoto  String?

  absent          Boolean       @default(false)

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([tripId, studentId])
  @@index([tripId])
  @@index([studentId])
}

// ==================== GPS LOCATION TRACKING ====================

model GPSLocation {
  id              String        @id @default(uuid())

  vehicleId       String
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  latitude        Decimal       @db.Decimal(10, 8)
  longitude       Decimal       @db.Decimal(11, 8)
  accuracy        Int           // In meters

  status          GPSStatus     @default(ONLINE)
  timestamp       DateTime      @default(now())

  createdAt       DateTime      @default(now())

  @@index([vehicleId])
  @@index([timestamp])
  @@index([vehicleId, timestamp])
}

// ==================== MAINTENANCE TRACKING ====================

model VehicleMaintenanceLog {
  id              String              @id @default(uuid())

  vehicleId       String
  vehicle         Vehicle             @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  maintenanceType MaintenanceType
  status          MaintenanceStatus   @default(SCHEDULED)

  date            DateTime            @default(now())
  notes           String?             @db.Text
  cost            Decimal?            @db.Decimal(10, 2)

  recordedById    String?
  recordedBy      User?               @relation(fields: [recordedById], references: [id])

  schoolId        String
  school          School              @relation(fields: [schoolId], references: [id])

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([vehicleId])
  @@index([status])
  @@index([date])
  @@index([schoolId])
}
